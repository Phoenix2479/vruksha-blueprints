/**
 * PDF Generator Utility
 * Uses pdfkit to create tabular PDF reports
 */

const PDFDocument = require('pdfkit');

const COLORS = {
  headerBg: '#1e293b',
  headerText: '#ffffff',
  rowAlt: '#f8fafc',
  border: '#e2e8f0',
  text: '#1e293b',
  muted: '#64748b',
  accent: '#3b82f6'
};

function createPDFDocument(options = {}) {
  return new PDFDocument({
    size: options.landscape ? 'A4' : 'A4',
    layout: options.landscape ? 'landscape' : 'portrait',
    margin: 40,
    bufferPages: true,
    info: {
      Title: options.title || 'Report',
      Author: 'Niyam Accounting',
      Creator: 'Niyam Max Docker'
    }
  });
}

function addHeader(doc, title, subtitle) {
  doc.fontSize(18).fillColor(COLORS.text).text(title, { align: 'left' });
  if (subtitle) {
    doc.fontSize(10).fillColor(COLORS.muted).text(subtitle, { align: 'left' });
  }
  doc.moveDown(0.5);
  doc.moveTo(40, doc.y).lineTo(doc.page.width - 40, doc.y).strokeColor(COLORS.border).stroke();
  doc.moveDown(0.5);
}

function addTable(doc, columns, rows, options = {}) {
  const startX = 40;
  const pageWidth = doc.page.width - 80;
  const totalWeight = columns.reduce((sum, c) => sum + (c.width || 1), 0);
  const colWidths = columns.map(c => ((c.width || 1) / totalWeight) * pageWidth);
  const rowHeight = options.rowHeight || 22;
  const fontSize = options.fontSize || 8;

  let y = doc.y;
  doc.rect(startX, y, pageWidth, rowHeight).fill(COLORS.headerBg);
  let x = startX;
  columns.forEach((col, i) => {
    doc.fontSize(fontSize).fillColor(COLORS.headerText)
      .text(col.label, x + 4, y + 5, { width: colWidths[i] - 8, align: col.align || 'left', lineBreak: false });
    x += colWidths[i];
  });
  y += rowHeight;

  rows.forEach((row, rowIdx) => {
    if (y + rowHeight > doc.page.height - 60) {
      doc.addPage();
      y = 40;
      doc.rect(startX, y, pageWidth, rowHeight).fill(COLORS.headerBg);
      let hx = startX;
      columns.forEach((col, i) => {
        doc.fontSize(fontSize).fillColor(COLORS.headerText)
          .text(col.label, hx + 4, y + 5, { width: colWidths[i] - 8, align: col.align || 'left', lineBreak: false });
        hx += colWidths[i];
      });
      y += rowHeight;
    }

    if (rowIdx % 2 === 1) {
      doc.rect(startX, y, pageWidth, rowHeight).fill(COLORS.rowAlt);
    }

    x = startX;
    columns.forEach((col, i) => {
      const val = col.formatter ? col.formatter(row[col.key], row) : (row[col.key] ?? '');
      doc.fontSize(fontSize).fillColor(COLORS.text)
        .text(String(val), x + 4, y + 5, { width: colWidths[i] - 8, align: col.align || 'left', lineBreak: false });
      x += colWidths[i];
    });
    y += rowHeight;
  });

  doc.y = y + 10;
}

function addFooter(doc) {
  const pages = doc.bufferedPageRange();
  for (let i = pages.start; i < pages.start + pages.count; i++) {
    doc.switchToPage(i);
    doc.fontSize(7).fillColor(COLORS.muted)
      .text(
        `Generated by Niyam Accounting  |  ${new Date().toLocaleDateString('en-IN')}  |  Page ${i + 1} of ${pages.count}`,
        40, doc.page.height - 30,
        { align: 'center', width: doc.page.width - 80 }
      );
  }
}

function sendPDF(res, buildFn, filename) {
  const doc = createPDFDocument({ landscape: false });
  res.setHeader('Content-Type', 'application/pdf');
  res.setHeader('Content-Disposition', `inline; filename="${filename}"`);
  doc.pipe(res);
  buildFn(doc);
  addFooter(doc);
  doc.end();
}

function sendLandscapePDF(res, buildFn, filename) {
  const doc = createPDFDocument({ landscape: true });
  res.setHeader('Content-Type', 'application/pdf');
  res.setHeader('Content-Disposition', `inline; filename="${filename}"`);
  doc.pipe(res);
  buildFn(doc);
  addFooter(doc);
  doc.end();
}

function fmtCurrency(val) {
  if (val === null || val === undefined) return '0.00';
  return Number(val).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(val) {
  if (!val) return '';
  return new Date(val).toLocaleDateString('en-IN');
}

module.exports = {
  createPDFDocument, addHeader, addTable, addFooter,
  sendPDF, sendLandscapePDF, fmtCurrency, fmtDate,
  COLORS
};
